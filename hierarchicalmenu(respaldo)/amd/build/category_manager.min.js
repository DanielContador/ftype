/**
 * Hierarchical Category Manager AMD module
 *
 * @module     profilefield_hierarchicalmenu/category_manager
 * @copyright  2024 DL Company
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/str","core/modal_factory","core/modal_events"],function(t,e,a,r){return{maxLevels:3,categoryData:{root:{items:[]}},init:function(){var e=this;t(document).ready(function(){var a=t("#hierarchical-category-manager"),r=parseInt(a.data("maxlevels"),10);!isNaN(r)&&r>0&&(e.maxLevels=r),e.bindEvents(),e.loadExistingData(),e.ensureIds(e.categoryData.root.items),e.saveData(),e.renderTree()})},bindEvents:function(){var e=this;t("#add-root-category").off("click").on("click",function(t){t.preventDefault(),e.showAddCategoryModal(null,0,null)}),t("#category-tree").off("click").on("click",".add-subcategory",function(a){a.preventDefault();var r=t(this).data("path"),o=parseInt(t(this).data("level"));e.showAddCategoryModal(r,o+1,null)}).on("click",".edit-category",function(a){a.preventDefault();var r=t(this).data("path");e.showEditCategoryModal(r)}).on("click",".delete-category",function(a){a.preventDefault();var r=t(this).data("path");e.showDeleteConfirmation(r)}),t('input[name="param2"]').off("change.hierarchicalmenu").on("change.hierarchicalmenu",function(){var a=parseInt(t(this).val(),10);!isNaN(a)&&a>0&&(e.maxLevels=a,e.renderTree())})},loadExistingData:function(){var e=t('textarea[name="param1"]').val();if(e&&""!==e.trim())try{var a=JSON.parse(e);if(a&&a.root&&Array.isArray(a.root.items))return void(this.categoryData=a)}catch(t){}this.categoryData={root:{items:[]}}},saveData:function(){t('textarea[name="param1"]').val(JSON.stringify(this.categoryData))},renderTree:function(){var e=t("#category-tree").empty();if(this.categoryData.root.items.length){var a=this.renderTreeLevel(this.categoryData.root.items,0,"");e.html('<ul class="category-tree-root">'+a+"</ul>")}else e.html('<p class="text-muted">No categories defined yet. Click "Add Root Category" to start.</p>')},renderTreeLevel:function(t,e,a){var r=this,o="";return t.forEach(function(t,n){var i=""===a?String(n):a+"-"+n,c=Array.isArray(t.childs)&&t.childs.length>0,s=e<r.maxLevels-1;o+='<li class="category-item level-'+e+'" data-path="'+i+'">',o+='  <div class="category-content">',o+='    <span class="category-name">'+r.escapeHtml(t.name)+"</span>",o+='    <div class="category-actions">',s&&(o+='      <button type="button" class="btn btn-sm btn-outline-primary add-subcategory" data-path="'+i+'" data-level="'+e+'" title="Add Subcategory">+ Sub</button>'),o+='      <button type="button" class="btn btn-sm btn-outline-secondary edit-category" data-path="'+i+'" title="Edit Category">Edit</button>',o+='      <button type="button" class="btn btn-sm btn-outline-danger delete-category" data-path="'+i+'" title="Delete Category">Delete</button>',o+="    </div>",o+="  </div>",c&&(o+='  <ul class="category-children">',o+=r.renderTreeLevel(t.childs,e+1,i),o+="  </ul>"),o+="</li>"}),o},showAddCategoryModal:function(t,o){var n=this;if(o>=this.maxLevels)e.get_string("maxlevelreached","profilefield_hierarchicalmenu",this.maxLevels).then(function(t){window.alert(t)});else{var i=0===o?"Add Root Category":"Add Subcategory";a.create({type:a.types.SAVE_CANCEL,title:i,body:'<div class="form-group">  <label for="category-name-input">Category Name:</label>  <input type="text" id="category-name-input" class="form-control" placeholder="Enter category name"></div>'}).then(function(a){a.getRoot().on(r.save,function(r){r.preventDefault();var o=a.getRoot().find("#category-name-input").val().trim();o?(n.addCategory(t,o),a.destroy()):e.get_string("emptycategoryname","profilefield_hierarchicalmenu").then(function(t){window.alert(t)})}),a.getRoot().on(r.cancel,function(){a.destroy()}),a.show(),a.getRoot().on(r.shown,function(){a.getRoot().find("#category-name-input").focus()})}).catch(function(t){console.error("Error creating modal:",t)})}},showEditCategoryModal:function(t){var o=this,n=this.findCategoryByPath(t);n?a.create({type:a.types.SAVE_CANCEL,title:"Edit Category",body:'<div class="form-group">  <label for="category-name-input">Category Name:</label>  <input type="text" id="category-name-input" class="form-control" value="'+this.escapeHtml(n.name)+'"></div>'}).then(function(a){a.getRoot().on(r.save,function(r){r.preventDefault();var n=a.getRoot().find("#category-name-input").val().trim();n?(o.editCategory(t,n),a.destroy()):e.get_string("emptycategoryname","profilefield_hierarchicalmenu").then(function(t){window.alert(t)})}),a.getRoot().on(r.cancel,function(){a.destroy()}),a.show(),a.getRoot().on(r.shown,function(){a.getRoot().find("#category-name-input").focus().select()})}).catch(function(t){console.error("Error creating edit modal:",t)}):console.error("Category not found:",t)},showDeleteConfirmation:function(t){confirm("Are you sure you want to delete this category and all its subcategories?")&&this.deleteCategory(t)},addCategory:function(t,e){var a={id:this.generateId(),name:e,childs:[]};if(null===t)this.categoryData.root.items.push(a);else{var r=this.findCategoryByPath(t);if(!r)return void console.error("Parent not found for path",t);r.childs=r.childs||[],r.childs.push(a)}this.saveData(),this.renderTree()},editCategory:function(t,e){var a=this.findCategoryByPath(t);a?(a.name=e,this.saveData(),this.renderTree()):console.error("Category not found for edit:",t)},deleteCategory:function(t){this.removeCategoryByPath(t)?(this.saveData(),this.renderTree()):console.error("Failed to delete category:",t)},findCategoryByPath:function(t){for(var e=String(t).split("-").map(function(t){return parseInt(t,10)}),a=this.categoryData.root.items,r=0;r<e.length;r++){var o=e[r];if(!Array.isArray(a)||o<0||o>=a.length)return null;var n=a[o];if(r===e.length-1)return n;a=n.childs}return null},removeCategoryByPath:function(t){for(var e=String(t).split("-").map(function(t){return parseInt(t,10)}),a=this.categoryData.root.items,r=0;r<e.length-1;r++){var o=e[r];if(!Array.isArray(a)||o<0||o>=a.length)return!1;a=a[o].childs}var n=e[e.length-1];return!(!Array.isArray(a)||n<0||n>=a.length)&&(a.splice(n,1),!0)},ensureIds:function(t){var e=this;(t||[]).forEach(function(t){t.id||(t.id=e.generateId()),Array.isArray(t.childs)||(t.childs=[]),e.ensureIds(t.childs)})},generateId:function(){return"n_"+Math.random().toString(36).slice(2)+Date.now().toString(36)},escapeHtml:function(t){var e=document.createElement("div");return e.textContent=t,e.innerHTML}}});