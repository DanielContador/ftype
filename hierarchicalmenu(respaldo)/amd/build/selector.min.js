define(["jquery"],function(n){function e(n,t,r){(n||[]).forEach(function(n){t[n.id]=n,r[n.id]=n.childs||[],e(n.childs||[],t,r)})}function t(e,t,r){e.empty(),r&&e.append(n("<option>").attr("value","").text(r)),t.forEach(function(t){e.append(n("<option>").attr("value",t.id).text(t.name))}),e.trigger("change.select2")}function r(n){return(n||[]).map(function(n){return{id:n.id,name:n.name}})}function a(n,e){return e&&n[e]||[]}function o(n,e){null!=e&&""!==e&&n.val(String(e))}function l(n){var e={};return n.forEach(function(n){e[n.key]=n.$el.val()||""}),e}function i(n,e){if(n.length)try{n.val(JSON.stringify(e))}catch(e){n.val("")}}return{init:function(c){var u=c.root||{items:[]},f={};e(u.items,{},f);var h=(c.levels||[]).map(function(n){return{key:n.key,placeholder:n.placeholder||"Choose..."}});if(h.length){var v=h.map(function(e){var t=c.fieldname+"["+e.key+"]";return{key:e.key,placeholder:e.placeholder,$el:n('select[name="'+t+'"]')}}),p=h.map(function(n){return n.placeholder||"Choose..."}),d=n('input[name="'+c.hidden+'"]'),y=function(n,e){var t=(n.levels||[]).map(function(n){return n.key}),r={};function a(n){if(!n||"object"!=typeof n)return null;var e={};return t.forEach(function(t){Object.prototype.hasOwnProperty.call(n,t)&&null!==n[t]&&void 0!==n[t]?e[t]=String(n[t]):e[t]=""}),e}t.forEach(function(n){r[n]=""});var o=a(n.current);if(!o&&e.length&&e.val())try{o=a(JSON.parse(e.val()))}catch(n){o=null}return o||r}(c,d);t(v[0].$el,r(u.items),p[0]),o(v[0].$el,y[h[0].key]);for(var m=1;m<v.length;m++){var s=y[h[m-1].key]||"",g=s?r(a(f,s)):[];t(v[m].$el,g,p[m]),o(v[m].$el,y[h[m].key])}i(d,l(v)),v.forEach(function(n,e){n.$el.on("change",function(){for(var n=e+1;n<v.length;n++){var o=v[n-1].$el.val()||"",c=o?r(a(f,o)):[];t(v[n].$el,c,p[n])}i(d,l(v))})})}}}});