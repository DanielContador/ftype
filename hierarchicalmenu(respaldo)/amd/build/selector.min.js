define(["jquery"],function(n){function e(n,t,r){var o=t||[];o.length||(r[""]=n||[]),(n||[]).forEach(function(n){var t=o.concat(String(n.id)),i=t.join("/");r[i]=n.childs||[],e(n.childs||[],t,r)})}function t(e,t,r){e.empty(),r&&e.append(n("<option>").attr("value","").text(r)),t.forEach(function(t){e.append(n("<option>").attr("value",t.id).text(t.name))}),e.trigger("change.select2")}function r(n){return(n||[]).map(function(n){return{id:n.id,name:n.name}})}function o(n,e){for(var t=[],r=0;r<=e;r++){var o=n[r];if(!o)return null;t.push(String(o))}return t.join("/")}function i(n,e){return e?n[e]||[]:[]}function a(n,e){null!=e&&""!==e&&n.val(String(e))}function l(n){var e={};return n.forEach(function(n){e[n.key]=n.$el.val()||""}),e}function c(n,e){if(n.length)try{n.val(JSON.stringify(e))}catch(e){n.val("")}}return{init:function(u){var f=u.root||{items:[]},h={};e(f.items,[],h);var v=(u.levels||[]).map(function(n){return{key:n.key,placeholder:n.placeholder||"Choose..."}});if(v.length){var p=v.map(function(e){var t=u.fieldname+"["+e.key+"]";return{key:e.key,placeholder:e.placeholder,$el:n('select[name="'+t+'"]')}}),d=v.map(function(n){return n.placeholder||"Choose..."}),y=n('input[name="'+u.hidden+'"]'),m=function(n,e){var t=(n.levels||[]).map(function(n){return n.key}),r={};function o(n){if(!n||"object"!=typeof n)return null;var e={};return t.forEach(function(t){Object.prototype.hasOwnProperty.call(n,t)&&null!==n[t]&&void 0!==n[t]?e[t]=String(n[t]):e[t]=""}),e}t.forEach(function(n){r[n]=""});var i=o(n.current);if(!i&&e.length&&e.val())try{i=o(JSON.parse(e.val()))}catch(n){i=null}return i||r}(u,y),s=v.map(function(n){return m[n.key]||""});t(p[0].$el,r(f.items),d[0]),a(p[0].$el,s[0]);for(var g=1;g<p.length;g++){var j=o(s,g-1),b=j?r(i(h,j)):[];t(p[g].$el,b,d[g]),a(p[g].$el,s[g])}c(y,l(p)),p.forEach(function(n,e){n.$el.on("change",function(){s[e]=n.$el.val()||"";for(var r=e+1;r<p.length;r++){var a=o(s,r-1),u=a?r(i(h,a)):[];t(p[r].$el,u,d[r]),s[r]=p[r].$el.val()||""}c(y,l(p))})})}}}});