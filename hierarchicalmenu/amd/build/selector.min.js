define(["jquery"],function(e){function t(e,n,a){(e||[]).forEach(function(e){n[e.id]=e,a[e.id]=e.childs||[],t(e.childs||[],n,a)})}function n(t,n,a){t.empty(),a&&t.append(e("<option>").attr("value","").text(a)),n.forEach(function(n){t.append(e("<option>").attr("value",n.id).text(n.name))}),t.trigger("change.select2")}function a(e){return(e||[]).map(function(e){return{id:e.id,name:e.name}})}function r(e,t){return t&&e[t]||[]}function l(e,t){null!=t&&""!==t&&e.val(String(t))}function i(e){var t={};return e.forEach(function(e){t[e.key]=e.$el.val()||""}),t}function o(e,t){if(e.length)try{e.val(JSON.stringify(t))}catch(t){e.val("")}}function c(e){var t={};return e.forEach(function(e){t[e]=""}),t}function u(t,n){if(!t.length||!t.val())return c(n);try{return function(t,n){var a=c(n);if(!t||"object"!=typeof t)return a;var r=e.extend({},a);return n.forEach(function(e){null!=t[e]&&(r[e]=String(t[e]))}),r}(JSON.parse(t.val()),n)}catch(e){return c(n)}}function f(t){if(t.length){var n=null,a=null,r=null;t.on("mousemove.hierarchicalmenuTooltip",function(e){r={pageX:e.pageX,pageY:e.pageY},u(c(e),r)}),t.on("mouseenter.hierarchicalmenuTooltip focus.hierarchicalmenuTooltip",function(e){r=i({pageX:e.pageX,pageY:e.pageY}),u(c(e),r)}),t.on("change.hierarchicalmenuTooltip input.hierarchicalmenuTooltip",function(e){u(c(e),i({pageX:e.pageX,pageY:e.pageY}))}),t.on("mouseleave.hierarchicalmenuTooltip blur.hierarchicalmenuTooltip",function(){l()}),e(document).on("scroll.hierarchicalmenuTooltip",l),t.data("hierarchicalmenuTooltipCleanup",function(){l(),n&&n.length&&n.remove(),e(document).off("scroll.hierarchicalmenuTooltip",l),t.off(".hierarchicalmenuTooltip"),t.removeData("hierarchicalmenuTooltipCleanup")})}function l(){a=null,r=null,n&&n.length&&n.removeClass("visible").attr("aria-hidden","true")}function i(e){return e&&"number"==typeof e.pageX&&"number"==typeof e.pageY?e:r&&"number"==typeof r.pageX&&"number"==typeof r.pageY?r:{pageX:(n=t[0].getBoundingClientRect()).left+window.pageXOffset+n.width/2,pageY:n.top+window.pageYOffset+n.height};var n}function o(t,o){var c=t.attr("data-full-label"),u=t.text();if(c&&u&&c!==u.trim()){var f=t.attr("value");a=f,r=i(o),(n&&n.length&&n.closest("body").length||(n=e("<div>",{class:"hierarchicalmenu-tooltip",role:"tooltip","aria-hidden":"true"}),e("body").append(n)),n).text(c).css({left:r.pageX+12,top:r.pageY+12}).addClass("visible").attr("aria-hidden","false")}else l()}function c(e){if(e&&e.target&&"OPTION"===e.target.tagName)return e.target;var n=t.find("option:selected");return n.length?n[0]:null}function u(t,c){if(t){var u=e(t),f=u.attr("value");if(a===f&&n&&n.hasClass("visible"))return r=i(c),void n.css({left:r.pageX+12,top:r.pageY+12});o(u,c)}else l()}}return{init:function(c){var u=c.root||{items:[]},f={};t(u.items,{},f);var p=(c.levels||[]).map(function(t){var n=c.fieldname+"["+t.key+"]";return{key:t.key,placeholder:t.placeholder||"Choose...",$el:e('select[name="'+n+'"]')}});if(p.length){var h=e('input[name="'+c.hidden+'"]'),v=function(e,t,n){var a=n.map(e=>e.key),r={};function l(e){var t={};return a.forEach(n=>t[n]=e&&null!=e[n]?String(e[n]):""),t}if(a.forEach(e=>r[e]=""),e.current&&"object"==typeof e.current)return l(e.current);if(t.length&&t.val())try{var i=JSON.parse(t.val());if(i&&"object"==typeof i)return l(i)}catch(e){}return r}(c,h,p);n(p[0].$el,a(u.items),p[0].placeholder),l(p[0].$el,v[p[0].key]);for(var g=1;g<p.length;g++){var s=v[p[g-1].key]||"",d=s?r(f,s):[];n(p[g].$el,a(d),p[g].placeholder),l(p[g].$el,v[p[g].key])}o(h,i(p)),p.forEach(function(e,t){e.$el.on("change",function(){for(var e=t+1;e<p.length;e++){var c=p[e-1].$el.val()||"",u=c?r(f,c):[];n(p[e].$el,a(u),p[e].placeholder),l(p[e].$el,p[e].val())}o(h,i(p))})})}},initLeaf:function(t){var n=Array.isArray(t.levelkeys)?t.levelkeys.slice():[],a=c(n),r=t.leafkey||(n.length?n[n.length-1]:"leaf"),l=t.leafmap||{},i=e('select[name="'+t.leafname+'"]'),p=e('input[name="'+t.hidden+'"]');if(i.length&&p.length){t.leaflabels&&"object"==typeof t.leaflabels&&(!function(t,n){t.length&&n&&t.find("option").each(function(){var t=e(this),a=t.attr("value");if(Object.prototype.hasOwnProperty.call(n,a)){var r=n[a];"string"==typeof r&&""!==r.trim()?t.attr("data-full-label",r):t.removeAttr("data-full-label")}else t.removeAttr("data-full-label")})}(i,t.leaflabels),f(i));var h=u(p,n),v=h[r]||i.val()||"";v?i.val(String(v)):i.val(""),g(i.val()||""),i.on("change",function(){g(e(this).val()||"")}),i.on("remove",function(){var e=i.data("hierarchicalmenuTooltipCleanup");"function"==typeof e&&e()})}function g(t){var i=function(t,n,a,r,l,i){var o=null!=l?String(l):"",c=e.extend({},n);if(!o)return c;if(Object.prototype.hasOwnProperty.call(t,o)){var u=t[o]||{};return a.forEach(function(e){null!=u[e]&&(c[e]=String(u[e]))}),c}return i&&i[r]===o?e.extend(c,i):c}(l,a,n,r,t,h);o(p,i),h=i}}}});