define(["jquery"],function(e){function t(e,n,a){(e||[]).forEach(function(e){n[e.id]=e,a[e.id]=e.childs||[],t(e.childs||[],n,a)})}function n(t,n,a){t.empty(),a&&t.append(e("<option>").attr("value","").text(a)),n.forEach(function(n){t.append(e("<option>").attr("value",n.id).text(n.name))}),t.trigger("change.select2")}function a(e){return(e||[]).map(function(e){return{id:e.id,name:e.name}})}function l(e,t){return t&&e[t]||[]}function r(e,t){null!=t&&""!==t&&e.val(String(t))}function i(e){var t={};return e.forEach(function(e){t[e.key]=e.$el.val()||""}),t}function o(e,t){if(e.length)try{e.val(JSON.stringify(t))}catch(t){e.val("")}}function c(e){var t={};return e.forEach(function(e){t[e]=""}),t}function u(t,n){if(!t.length||!t.val())return c(n);try{return function(t,n){var a=c(n);if(!t||"object"!=typeof t)return a;var l=e.extend({},a);return n.forEach(function(e){null!=t[e]&&(l[e]=String(t[e]))}),l}(JSON.parse(t.val()),n)}catch(e){return c(n)}}function f(t){if(t.length){var n=null,a=null,l=null;t.on("mousemove.hierarchicalmenuTooltip",function(e){e.target&&"OPTION"===e.target.tagName&&i(e.target,{pageX:e.pageX,pageY:e.pageY})}),t.on("mouseenter.hierarchicalmenuTooltip focus.hierarchicalmenuTooltip",function(e){i(e.target&&"OPTION"===e.target.tagName?e.target:t[0].options[t[0].selectedIndex]||null,{pageX:e.pageX,pageY:e.pageY})}),t.on("mouseleave.hierarchicalmenuTooltip blur.hierarchicalmenuTooltip change.hierarchicalmenuTooltip",function(){r()}),e(document).on("scroll.hierarchicalmenuTooltip",r),t.data("hierarchicalmenuTooltipCleanup",function(){r(),n&&n.length&&n.remove(),e(document).off("scroll.hierarchicalmenuTooltip",r),t.off(".hierarchicalmenuTooltip"),t.removeData("hierarchicalmenuTooltipCleanup")})}function r(){a&&(clearTimeout(a),a=null),l=null,n&&n.length&&n.removeClass("visible").attr("aria-hidden","true")}function i(i,o){if(i){var c=e(i),u=c.attr("data-full-label"),f=c.text();if(u&&f&&u!==f.trim()){var h=c.attr("value");l===h&&n&&n.hasClass("visible")?o&&n.css({left:o.pageX+12,top:o.pageY+12}):(l=h,a&&clearTimeout(a),a=setTimeout(function(){var a=o;if(!a||"number"!=typeof a.pageX||"number"!=typeof a.pageY){var l=t[0].getBoundingClientRect();a={pageX:l.left+window.pageXOffset+l.width/2,pageY:l.top+window.pageYOffset+l.height}}(n&&n.length&&n.closest("body").length||(n=e("<div>",{class:"hierarchicalmenu-tooltip",role:"tooltip","aria-hidden":"true"}),e("body").append(n)),n).text(u).css({left:a.pageX+12,top:a.pageY+12}).addClass("visible").attr("aria-hidden","false")},1e3))}else r()}else r()}}return{init:function(c){var u=c.root||{items:[]},f={};t(u.items,{},f);var h=(c.levels||[]).map(function(t){var n=c.fieldname+"["+t.key+"]";return{key:t.key,placeholder:t.placeholder||"Choose...",$el:e('select[name="'+n+'"]')}});if(h.length){var p=e('input[name="'+c.hidden+'"]'),v=function(e,t,n){var a=n.map(e=>e.key),l={};function r(e){var t={};return a.forEach(n=>t[n]=e&&null!=e[n]?String(e[n]):""),t}if(a.forEach(e=>l[e]=""),e.current&&"object"==typeof e.current)return r(e.current);if(t.length&&t.val())try{var i=JSON.parse(t.val());if(i&&"object"==typeof i)return r(i)}catch(e){}return l}(c,p,h);n(h[0].$el,a(u.items),h[0].placeholder),r(h[0].$el,v[h[0].key]);for(var g=1;g<h.length;g++){var s=v[h[g-1].key]||"",m=s?l(f,s):[];n(h[g].$el,a(m),h[g].placeholder),r(h[g].$el,v[h[g].key])}o(p,i(h)),h.forEach(function(e,t){e.$el.on("change",function(){for(var e=t+1;e<h.length;e++){var c=h[e-1].$el.val()||"",u=c?l(f,c):[];n(h[e].$el,a(u),h[e].placeholder),r(h[e].$el,h[e].val())}o(p,i(h))})})}},initLeaf:function(t){var n=Array.isArray(t.levelkeys)?t.levelkeys.slice():[],a=c(n),l=t.leafkey||(n.length?n[n.length-1]:"leaf"),r=t.leafmap||{},i=e('select[name="'+t.leafname+'"]'),h=e('input[name="'+t.hidden+'"]');if(i.length&&h.length){t.leaflabels&&"object"==typeof t.leaflabels&&(!function(t,n){t.length&&n&&t.find("option").each(function(){var t=e(this),a=t.attr("value");if(Object.prototype.hasOwnProperty.call(n,a)){var l=n[a];"string"==typeof l&&""!==l.trim()?t.attr("data-full-label",l):t.removeAttr("data-full-label")}else t.removeAttr("data-full-label")})}(i,t.leaflabels),f(i));var p=u(h,n),v=p[l]||i.val()||"";v?i.val(String(v)):i.val(""),g(i.val()||""),i.on("change",function(){g(e(this).val()||"")}),i.on("remove",function(){var e=i.data("hierarchicalmenuTooltipCleanup");"function"==typeof e&&e()})}function g(t){var i=function(t,n,a,l,r,i){var o=null!=r?String(r):"",c=e.extend({},n);if(!o)return c;if(Object.prototype.hasOwnProperty.call(t,o)){var u=t[o]||{};return a.forEach(function(e){null!=u[e]&&(c[e]=String(u[e]))}),c}return i&&i[l]===o?e.extend(c,i):c}(r,a,n,l,t,p);o(h,i),p=i}}}});