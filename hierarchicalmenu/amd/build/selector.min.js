define(["jquery"],function(y){function o(n,e,t){n.empty(),t&&n.append(y("<option>").attr("value","").text(t)),e.forEach(function(e){n.append(y("<option>").attr("value",e.id).text(e.name))}),n.trigger("change.select2")}function f(e){return(e||[]).map(function(e){return{id:e.id,name:e.name}})}function u(e,n){return n&&e[n]||[]}function h(e,n){null!=n&&""!==n&&e.val(String(n))}function v(e){var n={};return e.forEach(function(e){n[e.key]=e.$el.val()||""}),n}function d(n,e){if(n.length)try{n.val(JSON.stringify(e))}catch(e){n.val("")}}function c(e){var n={};return e.forEach(function(e){n[e]=""}),n}function r(e,n){if(!e.length||!e.val())return c(n);try{var t=JSON.parse(e.val());return r=t,i=c(a=n),r&&"object"==typeof r?(l=y.extend({},i),a.forEach(function(e){null!=r[e]&&(l[e]=String(r[e]))}),l):i}catch(e){return c(n)}var r,a,l,i}return{init:function(t){var e=t.root||{items:[]},r={},a=(!function n(e,t,r){(e||[]).forEach(function(e){t[e.id]=e,r[e.id]=e.childs||[],n(e.childs||[],t,r)})}(e.items,{},r),(t.levels||[]).map(function(e){var n=t.fieldname+"["+e.key+"]";return{key:e.key,placeholder:e.placeholder||"Choose...",$el:y('select[name="'+n+'"]')}}));if(a.length){var l=y('input[name="'+t.hidden+'"]'),n=((e,n,t)=>{var r=t.map(e=>e.key),a={};function l(n){var t={};return r.forEach(e=>t[e]=n&&null!=n[e]?String(n[e]):""),t}if(r.forEach(e=>a[e]=""),e.current&&"object"==typeof e.current)return l(e.current);if(n.length&&n.val())try{var i=JSON.parse(n.val());if(i&&"object"==typeof i)return l(i)}catch(e){}return a})(t,l,a);o(a[0].$el,f(e.items),a[0].placeholder),h(a[0].$el,n[a[0].key]);for(var i=1;i<a.length;i++){var c=n[a[i-1].key]||"",c=c?u(r,c):[];o(a[i].$el,f(c),a[i].placeholder),h(a[i].$el,n[a[i].key])}d(l,v(a)),a.forEach(function(e,t){e.$el.on("change",function(){for(var e=t+1;e<a.length;e++){var n=a[e-1].$el.val()||"",n=n?u(r,n):[];o(a[e].$el,f(n),a[e].placeholder),h(a[e].$el,a[e].val())}d(l,v(a))})})}},initLeaf:function(e){var o,f=Array.isArray(e.levelkeys)?e.levelkeys.slice():[],u=c(f),h=e.leafkey||(f.length?f[f.length-1]:"leaf"),v=e.leafmap||{},n=y('select[name="'+e.leafname+'"]'),p=y('input[name="'+e.hidden+'"]');function t(e){n=v,c=u,t=f,r=h,a=o,e=null!=(e=e)?String(e):"",i=y.extend({},c);var n,t,r,a,l,i,c=e?Object.prototype.hasOwnProperty.call(n,e)?(l=n[e]||{},t.forEach(function(e){null!=l[e]&&(i[e]=String(l[e]))}),i):a&&a[r]===e?y.extend(i,a):i:i;d(p,c),o=c}n.length&&p.length&&((e=(o=r(p,f))[h]||n.val()||"")?n.val(String(e)):n.val(""),t(n.val()||""),n.on("change",function(){t(y(this).val()||"")}))}}});